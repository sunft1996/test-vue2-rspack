"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ModuleFederationPlugin = void 0;
const config_1 = require("../config");
const SharePlugin_1 = require("../sharing/SharePlugin");
const validate_1 = require("../util/validate");
const ContainerPlugin_1 = require("./ContainerPlugin");
const ContainerReferencePlugin_1 = require("./ContainerReferencePlugin");
const ModuleFederationRuntimePlugin_1 = require("./ModuleFederationRuntimePlugin");
class ModuleFederationPlugin {
    constructor(_options) {
        this._options = _options;
    }
    apply(compiler) {
        const { _options: options } = this;
        const library = options.library || { type: "var", name: options.name };
        const remoteType = options.remoteType ||
            (options.library && (0, validate_1.isValidate)(options.library.type, config_1.externalsType)
                ? options.library.type
                : "script");
        if (library &&
            !compiler.options.output.enabledLibraryTypes.includes(library.type)) {
            compiler.options.output.enabledLibraryTypes.push(library.type);
        }
        compiler.hooks.afterPlugins.tap("ModuleFederationPlugin", () => {
            var _a;
            if (options.exposes &&
                (Array.isArray(options.exposes)
                    ? options.exposes.length > 0
                    : Object.keys(options.exposes).length > 0)) {
                new ContainerPlugin_1.ContainerPlugin({
                    name: options.name,
                    library,
                    filename: options.filename,
                    runtime: options.runtime,
                    shareScope: options.shareScope,
                    exposes: options.exposes
                }).apply(compiler);
            }
            if (options.remotes &&
                (Array.isArray(options.remotes)
                    ? options.remotes.length > 0
                    : Object.keys(options.remotes).length > 0)) {
                new ContainerReferencePlugin_1.ContainerReferencePlugin({
                    remoteType,
                    shareScope: options.shareScope,
                    remotes: options.remotes
                }).apply(compiler);
            }
            if (options.shared) {
                new SharePlugin_1.SharePlugin({
                    shared: options.shared,
                    shareScope: options.shareScope
                }).apply(compiler);
            }
            const runtimePlugins = (_a = options.runtimePlugins) !== null && _a !== void 0 ? _a : [];
            for (let plugin of runtimePlugins) {
                ModuleFederationRuntimePlugin_1.ModuleFederationRuntimePlugin.addPlugin(compiler, plugin);
            }
        });
    }
}
exports.ModuleFederationPlugin = ModuleFederationPlugin;
